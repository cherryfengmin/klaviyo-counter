<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Klaviyo 增长监控</title>
    <style>
        body { font-family: -apple-system, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background: #f0f2f5; }
        .card { background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; width: 300px; }
        .title { color: #666; font-size: 0.9rem; margin-bottom: 10px; }
        .number { font-size: 3.5rem; font-weight: bold; color: #15c39a; transition: all 0.5s ease; }
        .date-range { font-size: 0.75rem; color: #999; margin-top: 15px; }
        .loading { opacity: 0.5; }
    </style>
</head>
<body>
    <div class="card">
        <div class="title">Email 订阅增长数</div>
        <div id="counter" class="number">--</div>
        <div class="date-range">区间: 2026.03.01 - 2026.04.01</div>
        <div id="status" style="font-size: 10px; color: #ccc; margin-top: 10px;">正在获取实时数据...</div>
    </div>

    <script>
        async function updateData() {
            const counterEl = document.getElementById('counter');
            const statusEl = document.getElementById('status');
            
            try {
                const res = await fetch('/api/get-growth');
                const data = await res.json();
                console.log('API Response:', data);
                const initialValue = 0;
                const sumWithInitial = data.growth.reduce(
                (accumulator, currentValue) => accumulator + currentValue,
                initialValue,
                );

                console.log(sumWithInitial);
                if (data.growth !== undefined) {
                    // counterEl.innerText = data.growth.toLocaleString();
                    counterEl.innerText = sumWithInitial.toLocaleString();
                    statusEl.innerText = '最后同步: ' + new Date().toLocaleTimeString();
                }
            } catch (err) {
                statusEl.innerText = '更新失败，正在重试...';
            }
        }

        // 首次加载
        updateData();
        // 每 5 分钟更新一次 (Klaviyo API 聚合不是毫秒级的，没必要设置太快)
        setInterval(updateData, 300000);
    </script>
</body>
</html>